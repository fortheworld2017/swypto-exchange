// Generated by CoffeeScript 1.9.3
(function() {
  $(document).ready(function() {
    var $btcBankBalance, $markets, $paymentsTable, $resendEmailVerificationBt, $searchUserForm, $transactionsTable, $withdrawalsTable, rootUrl, updateBankBalance;
    $.tmpload.defaults.tplWrapper = _.template;
    $(document).ajaxSend(function(ev, xhr) {
      return xhr.setRequestHeader("X-CSRF-Token", CONFIG.csrf);
    });
    window.App = window.App || {};
    rootUrl = "/administratie";
    $btcBankBalance = $("#bank-balance-BTC");
    if ($btcBankBalance.length) {
      updateBankBalance = function() {
        var currency, defer, i, index, len, ref, updateBalanceByCurrency;
        defer = $.Deferred();
        updateBalanceByCurrency = function(currency, index) {
          return defer.then(function() {
            return setTimeout(function() {
              return $.getJSON(rootUrl + "/banksaldo/" + currency, function(response) {
                var balance;
                balance = _.isNumber(response.balance) ? _.str.numberFormat(response.balance, 3) : response.balance;
                return $("#bank-balance-" + response.currency).text(balance);
              });
            }, index * 500);
          });
        };
        index = 1;
        ref = CONFIG.currencies;
        for (i = 0, len = ref.length; i < len; i++) {
          currency = ref[i];
          updateBalanceByCurrency(currency, index);
          index++;
        }
        return defer.resolve();
      };
      setInterval(updateBankBalance, 60000);
      updateBankBalance();
      $(".show-wallet-info-bt").click(function(ev) {
        var $cnt, currency;
        ev.preventDefault();
        currency = $(ev.target).data("currency");
        $cnt = $("#wallet-info-cnt-" + currency);
        if (!$cnt.hasClass("hidden")) {
          return $cnt.addClass("hidden");
        } else {
          return $.post(rootUrl + "/wallet_info", {
            currency: currency
          }, function(response) {
            $("#wallet-address-" + currency).html(response.address);
            $("#wallet-info-" + currency).html(window.App.Helpers.JSON.toHTML(response.info));
            return $cnt.removeClass("hidden");
          });
        }
      });
    }
    $searchUserForm = $("#search-user-form");
    if ($searchUserForm.length) {
      $searchUserForm.submit(function(ev) {
        ev.preventDefault();
        return $.post(rootUrl + "/search_user", $(ev.target).serialize(), function(response) {
          if (response.id) {
            return $("#search-user-result").attr("href", rootUrl + "/user/" + response.id).text(response.id + " - " + response.email);
          } else {
            return alert("User could not be found.");
          }
        });
      });
    }
    $transactionsTable = $("#transactions");
    if ($transactionsTable.length) {
      $transactionsTable.delegate(".transaction-log-toggler", "click", function(ev) {
        var $logEl;
        ev.preventDefault();
        $logEl = $(ev.currentTarget).next(".transaction-log:first");
        return $logEl.toggleClass("hidden", !$logEl.hasClass("hidden"));
      });
    }
    $paymentsTable = $("#payments");
    if ($paymentsTable.length) {
      $paymentsTable.delegate(".payment-log-toggler", "click", function(ev) {
        var $logEl;
        ev.preventDefault();
        $logEl = $(ev.currentTarget).next(".payment-log:first");
        return $logEl.toggleClass("hidden", !$logEl.hasClass("hidden"));
      });
      $paymentsTable.delegate(".pay", "click", function(ev) {
        var $el;
        ev.preventDefault();
        $el = $(ev.currentTarget);
        return $.ajax({
          url: rootUrl + "/pay/" + ($el.data('id')),
          type: "put",
          dataType: "json",
          success: function(response) {
            $el.parent().find(".payment-status").text(response.status);
            return $el.parent().find("button").hide();
          },
          error: function(xhr) {
            return alert(xhr.responseText);
          }
        });
      });
      $paymentsTable.delegate(".remove", "click", function(ev) {
        var $el;
        ev.preventDefault();
        if (confirm("Are you sure?")) {
          $el = $(ev.currentTarget);
          return $.ajax({
            url: rootUrl + "/payment/" + ($el.data('id')),
            type: "delete",
            dataType: "json",
            success: function(response) {
              $el.parent().find(".payment-status").text(response.status);
              return $el.parent().find("button").hide();
            },
            error: function(xhr) {
              return alert(xhr.responseText);
            }
          });
        }
      });
    }
    $withdrawalsTable = $('#withdrawals');
    if ($withdrawalsTable.length) {
      $withdrawalsTable.delegate(".remove", "click", function(ev) {
        var $el;
        ev.preventDefault();
        if (confirm("Are you sure?")) {
          $el = $(ev.currentTarget);
          return $.ajax({
            url: rootUrl + "/withdrawal_actions/" + ($el.data('id')),
            type: "delete",
            dataType: "json",
            success: function(response) {
              $el.parent().find(".payment-status").text(response.status);
              return $el.parent().find("button").hide();
            },
            error: function(xhr) {
              return alert(xhr.responseText);
            }
          });
        }
      });
      $withdrawalsTable.delegate(".complete", "click", function(ev) {
        var $el;
        ev.preventDefault();
        $el = $(ev.currentTarget);
        return $.ajax({
          url: rootUrl + "/bank_withdrawal_complete/" + ($el.data('id')),
          type: "put",
          dataType: "json",
          success: function(response) {
            $el.parent().find(".payment-status").text(response.status);
            return $el.parent().find("button").hide();
          },
          error: function(xhr) {
            return alert(xhr.responseText);
          }
        });
      });
    }
    $markets = $("#markets");
    if ($markets.length) {
      $markets.delegate(".market-switcher", "click", function(ev) {
        var $el;
        ev.preventDefault();
        $el = $(ev.currentTarget);
        return $.ajax({
          url: rootUrl + "/markets/" + ($el.data('id')),
          type: "put",
          dataType: "json",
          data: {
            status: $el.data("status")
          },
          success: function(response) {
            return window.location.reload();
          }
        });
      });
    }
    $resendEmailVerificationBt = $("#resend-email-verification");
    if ($resendEmailVerificationBt.length) {
      return $resendEmailVerificationBt.click(function(ev) {
        var $target;
        if (!confirm("Are you sure?")) {
          return;
        }
        $target = $(ev.target);
        return $.post(rootUrl + "/resend_user_verification_email/" + ($target.data("id")), function(response) {
          if (response.user_id) {
            return alert("Verification successfully sent.");
          } else {
            return alert(xhr.responseText);
          }
        });
      });
    }
  });

}).call(this);
